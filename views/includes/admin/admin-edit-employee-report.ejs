<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Report - Week <%= report.duration %></title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --indigo: #4f46e5;
      --indigo-dark: #3730a3;
      --indigo-light: #818cf8;
      --violet: #7c3aed;
      --emerald: #10b981;
      --rose: #f43f5e;
      --amber: #f59e0b;
      --body-bg: #f0f0f7;
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Sora', sans-serif;
      background: var(--body-bg);
      background-image:
        radial-gradient(ellipse at 20% 0%, rgba(79,70,229,0.05) 0%, transparent 60%),
        radial-gradient(ellipse at 80% 100%, rgba(124,58,237,0.04) 0%, transparent 60%);
      min-height: 100vh;
    }

    /* ── Top Nav ─────────────────────────────── */
    nav {
      background: rgba(255,255,255,0.88);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(79,70,229,0.08);
    }

    .back-link {
      display: inline-flex; align-items: center; gap: 6px;
      font-size: 0.82rem; font-weight: 600; color: #64748b;
      text-decoration: none; padding: 6px 10px;
      border-radius: 8px; transition: all 0.15s;
    }
    .back-link:hover { background: rgba(79,70,229,0.06); color: var(--indigo); }

    .btn-cancel {
      padding: 8px 18px;
      background: none; border: 1.5px solid #e2e8f0; border-radius: 10px;
      font-size: 0.82rem; font-weight: 600; font-family: 'Sora', sans-serif;
      color: #475569; cursor: pointer; text-decoration: none;
      transition: all 0.15s; display: inline-flex; align-items: center;
    }
    .btn-cancel:hover { background: #f8fafc; border-color: #cbd5e1; }

    .btn-save {
      padding: 8px 20px;
      background: linear-gradient(135deg, var(--indigo), var(--violet));
      color: #fff; border: none; border-radius: 10px;
      font-size: 0.82rem; font-weight: 700; font-family: 'Sora', sans-serif;
      cursor: pointer; display: inline-flex; align-items: center; gap: 7px;
      transition: opacity 0.15s, box-shadow 0.15s;
      box-shadow: 0 2px 8px rgba(79,70,229,0.3);
    }
    .btn-save:hover { opacity: 0.9; box-shadow: 0 4px 14px rgba(79,70,229,0.4); }
    .btn-save:disabled { opacity: 0.65; cursor: not-allowed; }

    /* ── Cards ──────────────────────────────── */
    .card {
      background: #fff;
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,0.06);
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
      overflow: hidden;
    }

    .card-header {
      padding: 18px 22px;
      background: linear-gradient(135deg, #0f0e17, #1e1b4b);
    }
    .card-header-title { color: #fff; font-size: 0.95rem; font-weight: 700; }
    .card-header-sub   { color: rgba(255,255,255,0.45); font-size: 0.72rem; margin-top: 2px; }

    .card-header-light {
      padding: 18px 22px;
      background: #fff;
      border-bottom: 1px solid #f1f5f9;
    }

    /* ── Sidebar form fields ─────────────────── */
    .field-label {
      display: block;
      font-size: 0.68rem; font-weight: 700;
      color: #64748b; letter-spacing: 0.07em;
      text-transform: uppercase; margin-bottom: 6px;
    }
    .field-input {
      width: 100%; padding: 9px 12px;
      border: 1.5px solid #e2e8f0; border-radius: 10px;
      font-size: 0.82rem; font-family: 'Sora', sans-serif;
      outline: none; color: #0f172a; background: #f8fafc;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .field-input:focus {
      border-color: var(--indigo);
      box-shadow: 0 0 0 3px rgba(79,70,229,0.1);
      background: #fff;
    }
    .field-select {
      width: 100%; padding: 9px 12px;
      border: 1.5px solid #e2e8f0; border-radius: 10px;
      font-size: 0.82rem; font-family: 'Sora', sans-serif;
      outline: none; color: #0f172a; background: #f8fafc;
      transition: border-color 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }
    .field-select:focus {
      border-color: var(--indigo);
      box-shadow: 0 0 0 3px rgba(79,70,229,0.1);
      background: #fff;
    }
    .field-textarea {
      width: 100%; padding: 9px 12px;
      border: 1.5px solid #e2e8f0; border-radius: 10px;
      font-size: 0.82rem; font-family: 'Sora', sans-serif;
      outline: none; color: #0f172a; background: #f8fafc;
      resize: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .field-textarea:focus {
      border-color: var(--indigo);
      box-shadow: 0 0 0 3px rgba(79,70,229,0.1);
      background: #fff;
    }

    /* ── Section divider label ───────────────── */
    .section-label {
      font-size: 0.65rem; font-weight: 800;
      letter-spacing: 0.09em; text-transform: uppercase;
      color: #94a3b8; margin-bottom: 8px;
    }

    /* ── Leave/Attendance sub-card ───────────── */
    .sub-card {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 14px;
    }

    /* Half day radio cards */
    .half-day-card {
      padding: 8px 10px;
      border: 2px solid #e2e8f0;
      border-radius: 9px; text-align: center;
      cursor: pointer; transition: all 0.15s;
    }
    .half-day-card:has(input:checked) { border-color: var(--indigo); background: rgba(79,70,229,0.05); }

    /* Leave/Attendance entry items */
    .entry-item {
      display: flex; align-items: flex-start; justify-content: space-between; gap: 8px;
      background: #fff; border: 1px solid #e2e8f0; border-radius: 9px;
      padding: 8px 10px; transition: background 0.12s; margin-bottom: 6px;
    }
    .entry-item:last-child { margin-bottom: 0; }
    .entry-item:hover { background: #f8fafc; }
    .entry-remove-btn {
      width: 26px; height: 26px; border-radius: 7px; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      color: #f43f5e; background: none; border: none; cursor: pointer;
      transition: background 0.12s;
    }
    .entry-remove-btn:hover { background: rgba(244,63,94,0.08); }

    /* Btn inside sidebar */
    .btn-add-entry {
      width: 100%; padding: 8px 14px;
      background: linear-gradient(135deg, var(--indigo), var(--violet));
      color: #fff; border: none; border-radius: 9px;
      font-size: 0.78rem; font-weight: 700; font-family: 'Sora', sans-serif;
      cursor: pointer; transition: opacity 0.15s;
      box-shadow: 0 2px 6px rgba(79,70,229,0.25);
      display: flex; align-items: center; justify-content: center; gap: 5px;
    }
    .btn-add-entry:hover { opacity: 0.9; }

    /* Employee chip in sidebar */
    .emp-chip {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px; border-radius: 12px;
      background: rgba(79,70,229,0.04); border: 1px solid rgba(79,70,229,0.1);
    }
    .emp-avatar {
      width: 36px; height: 36px; border-radius: 9px;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.875rem; color: #fff; flex-shrink: 0;
      background: linear-gradient(135deg, var(--indigo), var(--violet));
    }

    /* Day count badge */
    .day-count-badge {
      padding: 6px 10px; background: #fff;
      border: 1px solid #e2e8f0; border-radius: 8px;
      font-size: 0.78rem; color: #475569;
    }

    /* ── Task cards ──────────────────────────── */
    .task-item {
      background: #fff;
      border: 2px solid #e2e8f0;
      border-radius: 14px;
      padding: 22px;
      position: relative;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .task-item:hover { border-color: #a5b4fc; box-shadow: 0 2px 12px rgba(79,70,229,0.07); }

    .task-number-badge {
      width: 38px; height: 38px; border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      background: linear-gradient(135deg, rgba(79,70,229,0.1), rgba(124,58,237,0.08));
      font-size: 0.82rem; font-weight: 800; color: var(--indigo);
      flex-shrink: 0;
    }

    .task-delete-btn {
      position: absolute; top: 16px; right: 16px;
      width: 34px; height: 34px; border-radius: 9px;
      display: flex; align-items: center; justify-content: center;
      color: #cbd5e1; background: none; border: none; cursor: pointer;
      transition: all 0.15s;
    }
    .task-delete-btn:hover { background: rgba(244,63,94,0.08); color: #f43f5e; }

    /* Status radio cards */
    .status-card {
      padding: 10px 6px;
      border: 2px solid #e2e8f0;
      border-radius: 10px; text-align: center;
      cursor: pointer; transition: all 0.15s;
    }
    .status-card:has(input[value="pending"]:checked)    { border-color: var(--amber); background: rgba(245,158,11,0.05); }
    .status-card:has(input[value="in-progress"]:checked){ border-color: var(--indigo); background: rgba(79,70,229,0.04); }
    .status-card:has(input[value="completed"]:checked)  { border-color: var(--emerald); background: rgba(16,185,129,0.04); }

    .status-label { font-size: 0.78rem; font-weight: 700; color: #475569; }
    .status-card:has(input[value="pending"]:checked)     .status-label { color: #d97706; }
    .status-card:has(input[value="in-progress"]:checked) .status-label { color: var(--indigo); }
    .status-card:has(input[value="completed"]:checked)   .status-label { color: #059669; }

    /* Add Task btn */
    .btn-add-task {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 18px;
      background: linear-gradient(135deg, var(--indigo), var(--violet));
      color: #fff; border: none; border-radius: 10px;
      font-size: 0.82rem; font-weight: 700; font-family: 'Sora', sans-serif;
      cursor: pointer; transition: opacity 0.15s;
      box-shadow: 0 2px 8px rgba(79,70,229,0.3);
    }
    .btn-add-task:hover { opacity: 0.9; }

    .task-count-badge {
      display: inline-flex; align-items: center;
      padding: 7px 14px; border-radius: 9px;
      background: rgba(79,70,229,0.07);
      color: var(--indigo); font-size: 0.78rem; font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
    }

    /* empty state */
    .empty-state-icon {
      width: 72px; height: 72px; border-radius: 18px; margin: 0 auto;
      display: flex; align-items: center; justify-content: center;
      background: rgba(79,70,229,0.06);
    }

    /* Meta footer in task */
    .task-meta { font-size: 0.72rem; color: #94a3b8; font-family: 'JetBrains Mono', monospace; }

    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .animate-spin { animation: spin 1s linear infinite; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 99px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  </style>
</head>
<body>

  <!-- ── Top Nav ─────────────────────────────── -->
  <nav class="sticky top-0 z-50 shadow-sm">
    <div class="px-4 sm:px-6 py-3.5">
      <div class="flex items-center justify-between gap-4">

        <!-- Left -->
        <div class="flex items-center gap-3 min-w-0">
          <a href="/admin/employees/<%= report.user._id %>/reports" class="back-link flex-shrink-0">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            Back
          </a>
          <span class="text-slate-200 hidden sm:block">|</span>
          <div class="hidden sm:block min-w-0">
            <p class="text-base font-bold text-slate-900 truncate">Edit Weekly Report</p>
            <p class="text-xs text-slate-400 mt-0.5">Make changes to the report and tasks</p>
          </div>
        </div>

        <!-- Right -->
        <div class="flex items-center gap-2 flex-shrink-0">
          <a href="/admin/employees/<%= report.user._id %>/reports" class="btn-cancel hidden sm:inline-flex">Cancel</a>
          <button type="button" id="saveButton" onclick="handleSave()" class="btn-save">
            <svg class="w-4 h-4" id="saveIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            <span id="saveText">Save Changes</span>
          </button>
        </div>

      </div>
    </div>
  </nav>

  <!-- ── Main Content ──────────────────────────── -->
  <div class="px-4 sm:px-6 py-6">
    <form id="editReportForm" action="/admin/employees/<%= report.user._id %>/reports/<%= report._id %>/update" method="POST">

      <input type="hidden" name="attendanceEvents" id="attendanceEventsHidden">

      <div class="grid grid-cols-12 gap-5">

        <!-- ── Left Sidebar ─────────────────── -->
        <div class="col-span-12 lg:col-span-3">
          <div class="card sticky top-20">

            <div class="card-header">
              <p class="card-header-title">Report Settings</p>
              <p class="card-header-sub">Week, leave & attendance</p>
            </div>

            <div class="p-5 space-y-5">

              <!-- Week Duration -->
              <div>
                <label class="field-label">Week Duration <span style="color:var(--rose)">*</span></label>
                <input type="text" name="duration" value="<%= report.duration %>" required
                       class="field-input" placeholder="e.g., W20">
              </div>

              <!-- ── LEAVE INFO ─────────── -->
              <div class="pt-1">
                <p class="section-label">Leave Information</p>

                <!-- Existing leaves -->
                <div class="mb-3">
                  <p class="field-label" style="margin-bottom:5px;">Existing Records</p>
                  <div id="existingLeavesList"></div>
                </div>

                <div class="sub-card space-y-3">
                  <div>
                    <label class="field-label">Add New Leave Entry</label>
                    <select id="leaveType" class="field-select" onchange="handleLeaveTypeChange()">
                      <option value="">Select Leave Type</option>
                      <option value="single-full">Single Day – Full Day</option>
                      <option value="single-half">Single Day – Half Day</option>
                      <option value="multiple">Multiple Days</option>
                      <option value="office-holiday">Office Holiday</option>
                    </select>
                  </div>

                  <!-- Single Day -->
                  <div id="singleDaySection" class="hidden">
                    <label class="field-label">Leave Date</label>
                    <input type="date" id="singleDate" class="field-input">
                  </div>

                  <!-- Half Day -->
                  <div id="halfDaySection" class="hidden">
                    <label class="field-label">Half Day Period</label>
                    <div class="grid grid-cols-2 gap-2">
                      <label class="half-day-card">
                        <input type="radio" name="halfDayPeriod" value="first-half" class="sr-only">
                        <p class="text-xs font-bold text-slate-700">First Half</p>
                        <p style="font-size:0.68rem;color:#94a3b8;">Morning</p>
                      </label>
                      <label class="half-day-card">
                        <input type="radio" name="halfDayPeriod" value="second-half" class="sr-only">
                        <p class="text-xs font-bold text-slate-700">Second Half</p>
                        <p style="font-size:0.68rem;color:#94a3b8;">Afternoon</p>
                      </label>
                    </div>
                  </div>

                  <!-- Multiple Days -->
                  <div id="multipleDaysSection" class="hidden space-y-3">
                    <div>
                      <label class="field-label">From Date</label>
                      <input type="date" id="fromDate" class="field-input" onchange="calculateLeaveDays()">
                    </div>
                    <div>
                      <label class="field-label">To Date</label>
                      <input type="date" id="toDate" class="field-input" onchange="calculateLeaveDays()">
                    </div>
                    <div id="leaveDaysCount" class="hidden day-count-badge">
                      Total: <span id="totalDays" style="font-weight:800;color:#0f172a;">0</span> days
                    </div>
                  </div>

                  <!-- Office Holiday -->
                  <div id="officeHolidaySection" class="hidden space-y-3">
                    <div>
                      <label class="field-label">Holiday Date</label>
                      <input type="date" id="holidayDate" class="field-input">
                    </div>
                    <div>
                      <label class="field-label">Holiday Name</label>
                      <input type="text" id="holidayName" placeholder="e.g. Diwali, Christmas" class="field-input">
                    </div>
                  </div>

                  <!-- Notes -->
                  <div id="leaveNotesSection" class="hidden">
                    <label class="field-label">Reason / Notes</label>
                    <textarea id="leaveNotes" rows="2" placeholder="Reason for leave…" class="field-textarea"></textarea>
                  </div>

                  <button type="button" id="addLeaveBtn" onclick="addLeaveEntry()" class="btn-add-entry hidden">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Add Leave Entry
                  </button>
                </div>
              </div>

              <!-- ── ATTENDANCE EVENTS ────── -->
              <div class="pt-1 border-t border-slate-100">
                <p class="section-label" style="margin-bottom:10px;">Early Leave & Late Arrival</p>

                <div class="mb-3">
                  <p class="field-label" style="margin-bottom:5px;">Existing Entries</p>
                  <div id="attendanceEventList"></div>
                </div>

                <div class="sub-card space-y-3">
                  <div>
                    <label class="field-label">Type</label>
                    <select id="attendanceEventType" class="field-select">
                      <option value="">Select Type</option>
                      <option value="early-leave">Early Leave</option>
                      <option value="late-arrival">Late Arrival</option>
                    </select>
                  </div>
                  <div>
                    <label class="field-label">Date</label>
                    <input type="date" id="attendanceEventDate" class="field-input">
                  </div>
                  <div>
                    <label class="field-label">Time</label>
                    <input type="time" id="attendanceEventTime" class="field-input">
                    <p style="font-size:0.7rem;color:#94a3b8;margin-top:4px;">Actual departure / arrival time</p>
                  </div>
                  <div>
                    <label class="field-label">Reason</label>
                    <input type="text" id="attendanceEventReason" placeholder="Brief reason" class="field-input">
                  </div>
                  <button type="button" onclick="addAttendanceEvent()" class="btn-add-entry">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Add Entry
                  </button>
                </div>
              </div>

              <!-- Employee info -->
              <div class="pt-1 border-t border-slate-100">
                <p class="section-label" style="margin-bottom:8px;">Employee Info</p>
                <div class="emp-chip">
                  <div class="emp-avatar"><%= report.user.name.charAt(0).toUpperCase() %></div>
                  <div>
                    <p style="font-size:0.82rem;font-weight:700;color:#0f172a;"><%= report.user.name %></p>
                    <p style="font-size:0.72rem;color:#94a3b8;font-family:'JetBrains Mono',monospace;"><%= report.user.userId %></p>
                  </div>
                </div>
              </div>

              <!-- Task count -->
              <div>
                <p class="section-label" style="margin-bottom:4px;">Total Tasks</p>
                <p style="font-size:2rem;font-weight:800;color:#0f172a;line-height:1;"><%= report.tasks.length %></p>
              </div>

            </div>
          </div>
        </div>

        <!-- ── Main — Task Editor ────────────── -->
        <div class="col-span-12 lg:col-span-9">
          <div class="card">

            <div class="card-header-light">
              <div class="flex items-center justify-between">
                <div>
                  <p style="font-size:1.05rem;font-weight:800;color:#0f172a;">Edit Tasks</p>
                  <p style="font-size:0.78rem;color:#94a3b8;margin-top:2px;">Update task details and status</p>
                </div>
                <div class="flex items-center gap-3">
                  <button type="button" onclick="addNewTask()" class="btn-add-task">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Add Task
                  </button>
                  <span class="task-count-badge"><%= report.tasks.length %> Task<%= report.tasks.length !== 1 ? 's' : '' %></span>
                </div>
              </div>
            </div>

            <div class="p-5">
              <div id="tasksList" class="space-y-4" data-task-count="<%= report.tasks.length %>">

                <% if (report.tasks.length === 0) { %>
                <div id="emptyTaskMessage" class="text-center py-16">
                  <div class="empty-state-icon mb-4">
                    <svg class="w-8 h-8" style="color:#c7d2fe" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                  </div>
                  <p style="font-size:1rem;font-weight:700;color:#1e293b;margin-bottom:4px;">No Tasks Yet</p>
                  <p style="font-size:0.82rem;color:#94a3b8;">Click "Add Task" to create your first task</p>
                </div>
                <% } %>

                <% report.tasks.forEach((task, index) => { %>
                <div class="task-item" data-task-id="<%= task._id %>">

                  <button type="button" onclick="deleteTask('<%= report._id %>', '<%= task._id %>')" class="task-delete-btn" title="Delete task">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                  </button>

                  <div class="pr-12">

                    <!-- Task header -->
                    <div class="flex items-center gap-3 mb-5">
                      <div class="task-number-badge">#<%= index + 1 %></div>
                      <p style="font-size:1rem;font-weight:800;color:#0f172a;">Task <%= index + 1 %></p>
                    </div>

                    <input type="hidden" name="tasks[<%= index %>][taskId]" value="<%= task._id %>">

                    <!-- Task Name -->
                    <div class="mb-4">
                      <label class="field-label">Task Name <span style="color:var(--rose)">*</span></label>
                      <input type="text" name="tasks[<%= index %>][taskName]" value="<%= task.taskName %>" required class="field-input">
                    </div>

                    <!-- Description -->
                    <div class="mb-4">
                      <label class="field-label">Description</label>
                      <textarea name="tasks[<%= index %>][description]" rows="3" class="field-textarea"><%= task.description || '' %></textarea>
                    </div>

                    <!-- Status -->
                    <div class="mb-4">
                      <label class="field-label">Status <span style="color:var(--rose)">*</span></label>
                      <div class="grid grid-cols-3 gap-3">
                        <label class="status-card">
                          <input type="radio" name="tasks[<%= index %>][status]" value="pending" <%= task.status === 'pending' ? 'checked' : '' %> class="sr-only">
                          <span class="status-label">Pending</span>
                        </label>
                        <label class="status-card">
                          <input type="radio" name="tasks[<%= index %>][status]" value="in-progress" <%= task.status === 'in-progress' ? 'checked' : '' %> class="sr-only">
                          <span class="status-label">In Progress</span>
                        </label>
                        <label class="status-card">
                          <input type="radio" name="tasks[<%= index %>][status]" value="completed" <%= task.status === 'completed' ? 'checked' : '' %> class="sr-only">
                          <span class="status-label">Completed</span>
                        </label>
                      </div>
                    </div>

                    <!-- Meta -->
                    <div class="pt-4 border-t border-slate-100">
                      <p class="task-meta">Created: <%= new Date(task.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %></p>
                    </div>

                  </div>
                </div>
                <% }); %>

              </div>
            </div>
          </div>
        </div>

      </div>
    </form>
  </div>

  <!-- Hidden report data -->
  <div id="reportData"
    data-leave-info='<%- JSON.stringify(report.leaveInfo || []).replace(/\n/g, " ").replace(/\r/g, " ") %>'
    style="display:none;">
  </div>


<script>
  // ─────────────────────────────────────────
  // LEAVE
  // ─────────────────────────────────────────
  let leaveArray = [];

  document.addEventListener('DOMContentLoaded', function () {
    initializeExistingLeaves();
    initializeExistingAttendanceEvents();
  });

  function initializeExistingLeaves() {
    try {
      const raw = document.getElementById('reportData').getAttribute('data-leave-info');
      const cleaned = raw.replace(/[\u0000-\u001F\u007F]/g, ' ');
      leaveArray = JSON.parse(cleaned).filter(Boolean);
      renderExistingLeaves();
    } catch (error) {
      console.error('Error initializing leaves:', error);
      leaveArray = [];
      renderExistingLeaves();
    }
  }

  function renderExistingLeaves() {
    const container = document.getElementById('existingLeavesList');
    if (!container) return;

    if (leaveArray.length === 0) {
      container.innerHTML = '<p style="font-size:0.75rem;color:#94a3b8;font-style:italic;">No leave entries yet</p>';
      return;
    }

    container.innerHTML = leaveArray.map((leave, index) => `
      <div class="entry-item">
        <span style="font-size:0.75rem;color:#475569;flex:1;line-height:1.4;">${escapeHtml(leave)}</span>
        <button type="button" onclick="removeLeave(${index})" class="entry-remove-btn">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
        <input type="hidden" name="leaveInfo[]" value="${escapeHtml(leave)}">
      </div>
    `).join('');
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function handleLeaveTypeChange() {
    const leaveType = document.getElementById('leaveType').value;
    const sections = ['singleDaySection', 'halfDaySection', 'multipleDaysSection', 'officeHolidaySection', 'leaveNotesSection'];
    sections.forEach(id => document.getElementById(id)?.classList.add('hidden'));
    document.getElementById('addLeaveBtn').classList.add('hidden');

    document.getElementById('singleDate').value = '';
    document.getElementById('leaveNotes').value = '';
    document.getElementById('fromDate').value = '';
    document.getElementById('toDate').value = '';
    document.getElementById('holidayDate').value = '';
    document.getElementById('holidayName').value = '';
    document.querySelectorAll('input[name="halfDayPeriod"]').forEach(r => r.checked = false);

    if (leaveType === 'single-full') {
      document.getElementById('singleDaySection').classList.remove('hidden');
      document.getElementById('leaveNotesSection').classList.remove('hidden');
      document.getElementById('addLeaveBtn').classList.remove('hidden');
    } else if (leaveType === 'single-half') {
      document.getElementById('singleDaySection').classList.remove('hidden');
      document.getElementById('halfDaySection').classList.remove('hidden');
      document.getElementById('leaveNotesSection').classList.remove('hidden');
      document.getElementById('addLeaveBtn').classList.remove('hidden');
    } else if (leaveType === 'multiple') {
      document.getElementById('multipleDaysSection').classList.remove('hidden');
      document.getElementById('leaveNotesSection').classList.remove('hidden');
      document.getElementById('addLeaveBtn').classList.remove('hidden');
    } else if (leaveType === 'office-holiday') {
      document.getElementById('officeHolidaySection').classList.remove('hidden');
      document.getElementById('addLeaveBtn').classList.remove('hidden');
    }
  }

  function calculateLeaveDays() {
    const fromDate = document.getElementById('fromDate').value;
    const toDate = document.getElementById('toDate').value;
    const leaveDaysCount = document.getElementById('leaveDaysCount');
    const totalDaysSpan = document.getElementById('totalDays');

    if (fromDate && toDate) {
      const from = new Date(fromDate);
      const to = new Date(toDate);
      if (to >= from) {
        const diffDays = Math.ceil(Math.abs(to - from) / (1000 * 60 * 60 * 24)) + 1;
        totalDaysSpan.textContent = diffDays;
        leaveDaysCount.classList.remove('hidden');
      } else {
        leaveDaysCount.classList.add('hidden');
      }
    } else {
      leaveDaysCount.classList.add('hidden');
    }
  }

  function addLeaveEntry() {
    const leaveType = document.getElementById('leaveType').value;
    let leaveInfoText = '';

    if (leaveType === 'single-full') {
      const date = document.getElementById('singleDate').value;
      const notes = document.getElementById('leaveNotes').value.trim();
      if (!date) return alert('Please select a leave date');
      const formattedDate = new Date(date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      leaveInfoText = `Full Day Leave on ${formattedDate}`;
      if (notes) leaveInfoText += ` - ${notes}`;

    } else if (leaveType === 'single-half') {
      const date = document.getElementById('singleDate').value;
      const period = document.querySelector('input[name="halfDayPeriod"]:checked')?.value;
      const notes = document.getElementById('leaveNotes').value.trim();
      if (!date) return alert('Please select a leave date');
      if (!period) return alert('Please select half day period');
      const formattedDate = new Date(date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      const periodText = period === 'first-half' ? 'First Half (Morning)' : 'Second Half (Afternoon)';
      leaveInfoText = `Half Day Leave (${periodText}) on ${formattedDate}`;
      if (notes) leaveInfoText += ` - ${notes}`;

    } else if (leaveType === 'multiple') {
      const fromDate = document.getElementById('fromDate').value;
      const toDate = document.getElementById('toDate').value;
      const notes = document.getElementById('leaveNotes').value.trim();
      if (!fromDate || !toDate) return alert('Please select both from and to dates');
      const fmtFrom = new Date(fromDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      const fmtTo = new Date(toDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      const totalDays = document.getElementById('totalDays').textContent;
      leaveInfoText = `Leave from ${fmtFrom} to ${fmtTo} (${totalDays} days)`;
      if (notes) leaveInfoText += ` - ${notes}`;

    } else if (leaveType === 'office-holiday') {
      const date = document.getElementById('holidayDate').value;
      const name = document.getElementById('holidayName').value.trim();
      if (!date) return alert('Please select holiday date');
      if (!name) return alert('Please enter holiday name');
      const formattedDate = new Date(date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      leaveInfoText = `Office Holiday: ${name} on ${formattedDate}`;
    }

    if (leaveInfoText) {
      leaveArray.push(leaveInfoText);
      renderExistingLeaves();
      document.getElementById('leaveType').value = '';
      handleLeaveTypeChange();
    }
  }

  function removeLeave(index) {
    if (confirm('Remove this leave entry?')) {
      leaveArray.splice(index, 1);
      renderExistingLeaves();
    }
  }

  // ─────────────────────────────────────────
  // ATTENDANCE EVENTS
  // ─────────────────────────────────────────
  let attendanceEvents = [];

  function initializeExistingAttendanceEvents() {
    try {
      const raw = JSON.parse('<%- JSON.stringify(report.attendanceEvents || []) %>');
      attendanceEvents = Array.isArray(raw) ? raw : [];
      renderAttendanceEvents();
    } catch (err) {
      console.error('Error initializing attendance events:', err);
      attendanceEvents = [];
      renderAttendanceEvents();
    }
  }

  function formatTimeTo12hr(time24) {
    const [hrs, mins] = time24.split(':');
    const h = parseInt(hrs);
    const suffix = h >= 12 ? 'PM' : 'AM';
    return `${h % 12 || 12}:${mins} ${suffix}`;
  }

  function addAttendanceEvent() {
    const type   = document.getElementById('attendanceEventType').value;
    const date   = document.getElementById('attendanceEventDate').value;
    const time   = document.getElementById('attendanceEventTime').value;
    const reason = document.getElementById('attendanceEventReason').value.trim();

    if (!type)   return alert('Select type (Early Leave or Late Arrival)');
    if (!date)   return alert('Select a date');
    if (!time)   return alert('Enter a time');

    const formattedDate = new Date(date).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' });
    const formattedTime = formatTimeTo12hr(time);
    const typeLabel = type === 'early-leave' ? 'Early Leave' : 'Late Arrival';
    let label = `${typeLabel} on ${formattedDate} at ${formattedTime}`;
    if (reason) label += ` — ${reason}`;

    attendanceEvents.push({ type, date, time, reason, label });
    renderAttendanceEvents();

    document.getElementById('attendanceEventType').value  = '';
    document.getElementById('attendanceEventDate').value  = '';
    document.getElementById('attendanceEventTime').value  = '';
    document.getElementById('attendanceEventReason').value = '';
  }

  function renderAttendanceEvents() {
    const list   = document.getElementById('attendanceEventList');
    const hidden = document.getElementById('attendanceEventsHidden');
    if (!list || !hidden) return;

    hidden.value = JSON.stringify(attendanceEvents);

    if (attendanceEvents.length === 0) {
      list.innerHTML = '<p style="font-size:0.75rem;color:#94a3b8;font-style:italic;">No entries</p>';
      return;
    }

    list.innerHTML = attendanceEvents.map((event, index) => {
      const displayType = (event.type || '').replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
      const dateVal     = event.date ? new Date(event.date) : new Date();
      const formattedDate = dateVal.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
      const displayTime = event.time ? formatTimeTo12hr(event.time) : 'N/A';
      const dotColor    = event.type === 'early-leave' ? '#fb923c' : '#a78bfa';

      return `
        <div class="entry-item">
          <div style="flex:1;">
            <div style="display:flex;align-items:center;gap:5px;margin-bottom:2px;">
              <span style="width:6px;height:6px;border-radius:50%;background:${dotColor};display:inline-block;flex-shrink:0;"></span>
              <span style="font-size:0.75rem;font-weight:700;color:#0f172a;">${displayType}</span>
            </div>
            <p style="font-size:0.72rem;color:#64748b;">${formattedDate} at ${displayTime}</p>
            ${event.reason ? `<p style="font-size:0.7rem;color:#94a3b8;font-style:italic;">"${event.reason}"</p>` : ''}
          </div>
          <button type="button" onclick="removeAttendanceEvent(${index})" class="entry-remove-btn">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
      `;
    }).join('');
  }

  function removeAttendanceEvent(index) {
    if (confirm('Remove this attendance entry?')) {
      attendanceEvents.splice(index, 1);
      renderAttendanceEvents();
    }
  }

  // ─────────────────────────────────────────
  // FORM SAVE
  // ─────────────────────────────────────────
  function handleSave() {
    document.getElementById('attendanceEventsHidden').value = JSON.stringify(attendanceEvents);

    const saveButton = document.getElementById('saveButton');
    const saveText   = document.getElementById('saveText');
    const saveIcon   = document.getElementById('saveIcon');

    saveButton.disabled = true;
    saveText.textContent = 'Saving…';
    saveIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>';
    saveIcon.classList.add('animate-spin');

    setTimeout(() => {
      document.getElementById('editReportForm').submit();
    }, 500);
  }

  // ─────────────────────────────────────────
  // TASKS
  // ─────────────────────────────────────────
  function deleteTask(reportId, taskId) {
    if (!confirm('Are you sure you want to delete this task? This action cannot be undone.')) return;

    const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
    if (taskElement) { taskElement.style.opacity = '0.5'; taskElement.style.pointerEvents = 'none'; }

    fetch(`/admin/employees/<%= report.user._id %>/reports/${reportId}/task/${taskId}/delete`, {
      method: 'DELETE', headers: { 'Content-Type': 'application/json' }
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          if (taskElement) {
            taskElement.style.transition = 'all 0.3s ease';
            taskElement.style.transform  = 'translateX(100%)';
            taskElement.style.opacity    = '0';
            setTimeout(() => window.location.reload(), 300);
          }
        } else {
          alert('Error deleting task: ' + data.message);
          if (taskElement) { taskElement.style.opacity = '1'; taskElement.style.pointerEvents = 'auto'; }
        }
      })
      .catch(err => {
        console.error('Error:', err);
        alert('Error deleting task. Please try again.');
        if (taskElement) { taskElement.style.opacity = '1'; taskElement.style.pointerEvents = 'auto'; }
      });
  }

  let newTaskIndex = parseInt(document.getElementById('tasksList').dataset.taskCount, 10) || 0;

  function addNewTask() {
    const list     = document.getElementById('tasksList');
    const emptyMsg = document.getElementById('emptyTaskMessage');
    if (emptyMsg) emptyMsg.remove();

    list.insertAdjacentHTML('beforeend', `
      <div class="task-item">
        <button type="button" onclick="removeLocalTask(this)" class="task-delete-btn" title="Remove task">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
          </svg>
        </button>
        <div class="pr-12">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
            <div class="task-number-badge">#${newTaskIndex + 1}</div>
            <p style="font-size:1rem;font-weight:800;color:#0f172a;">Task ${newTaskIndex + 1}</p>
          </div>
          <div style="margin-bottom:16px;">
            <label class="field-label">Task Name <span style="color:var(--rose)">*</span></label>
            <input type="text" name="tasks[${newTaskIndex}][taskName]" required class="field-input">
          </div>
          <div style="margin-bottom:16px;">
            <label class="field-label">Description</label>
            <textarea name="tasks[${newTaskIndex}][description]" rows="3" class="field-textarea"></textarea>
          </div>
          <div style="margin-bottom:16px;">
            <label class="field-label">Status <span style="color:var(--rose)">*</span></label>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
              <label class="status-card">
                <input type="radio" name="tasks[${newTaskIndex}][status]" value="pending" checked class="sr-only">
                <span class="status-label">Pending</span>
              </label>
              <label class="status-card">
                <input type="radio" name="tasks[${newTaskIndex}][status]" value="in-progress" class="sr-only">
                <span class="status-label">In Progress</span>
              </label>
              <label class="status-card">
                <input type="radio" name="tasks[${newTaskIndex}][status]" value="completed" class="sr-only">
                <span class="status-label">Completed</span>
              </label>
            </div>
          </div>
        </div>
      </div>
    `);

    newTaskIndex++;
  }

  function removeLocalTask(btn) {
    btn.closest('.task-item').remove();
  }
</script>

</body>
</html>